<DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>NACo Paths to VP</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width">
  <link rel="icon" type="image/png" href="favicon.ico">
  <style>
  body {
    padding-top: 60px;
    padding-bottom: 40px;
    text-align: center;
  }
  </style>

<link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.1.1/css/bootstrap.no-responsive.no-icons.min.css" rel="stylesheet">
<!-- <link rel="stylesheet" href="/css/bootstrap.min.css"> -->
<link  rel="stylesheet"
    href="http://netdna.bootstrapcdn.com/font-awesome/2.0/css/font-awesome.css">
  <link rel="stylesheet" href="libraries/frameworks/bootstrap/css/bootstrap-responsive.min.css">

  <link rel="stylesheet" href="libraries/frameworks/bootstrap/css/main.css">
  <link rel="stylesheet" href="libraries/highlighters/prettify/css/twitter-bootstrap.css" />
  <script src="libraries/frameworks/bootstrap/js/vendor/modernizr-2.6.1-respond-1.1.0.min.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="libraries/frameworks/bootstrap/js/vendor/jquery-1.8.2.min.js"><\/script>')</script>
    <link rel=stylesheet href="libraries/widgets/x512paths/external/nyt_512.css"></link>
<link rel=stylesheet href="./assets/css/ribbons.css"></link>
<link rel=stylesheet href="http://fonts.googleapis.com/css?family=Open+Sans"></link>
<link rel=stylesheet href="http://fonts.googleapis.com/css?family=Open+Sans+Condensed:700"></link>

  <script src="libraries/widgets/x512paths/external/d3.v3.min.js"></script>

</head>
<body>
   <!--[if lt IE 7]>
     <p class="chromeframe">You are using an outdated browser.
       <a href="http://browsehappy.com/">Upgrade your browser today</a> or
       <a href="http://www.google.com/chromeframe/?redirect=true">
         install Google Chrome Frame
       </a> to better experience this site.
    </p>
   <![endif]-->
   <!-- Ref: http://twitter.github.com/bootstrap/examples/hero.html -->

<div class="container">

  <h2 style="text-align: left;"><u>Paths to the NACo Vice Presidency: Sharief vs Jeffers Scenarios</u></h2><br />

  <h5 style="text-align: left;">Assumptions</h5>
  <ul style="text-align: left; font-style: italic;">
    <li>Barbara Sharief takes all of Florida's votes</li>
    <li>Ray Jeffers takes all of North Carolina's votes</li>
    <li>Select a winner-take-all for each of the otherwise 16 states with the most votes (excluding Florida and North Carolina)</li>
    <li>There are a remaining 459 votes among all other remaining states. This model assumes Sharief wins 50% of these votes (select a different % in blue)</li>
  </ul>
  <br />

<div style="display: flex; font-size: 18px; font-weight: 600; justify-content: space-around; margin-bottom: 10px; width: 100%;;">

<a href="Jeffers-0-percent.html">0%</a>
<a href="Jeffers-10-percent.html">10%</a>
<a href="Jeffers-20-percent.html">20%</a>
<a href="Jeffers-30-percent.html">30%</a>
<a href="Jeffers-40-percent.html">40%</a>
<a href="Jeffers-50-percent.html">50%</a>
<a href="Jeffers-60-percent.html">60%</a>
<a href="Jeffers-70-percent.html">70%</a>
<a href="Jeffers-80-percent.html">80%</a>
<a href="Jeffers-90-percent.html">90%</a>
<a href="Jeffers-100-percent.html">100%</a>

</div>

<div id = 'g-chart' class = 'rChart x512paths'></div>

<div class="g-controls"></div>

<div class="g-chart">
</div>

<script>

(function() {

//get parameters from rCharts
var params = {
 "dom": "g-chart",
"width":    1300,
"height":    700,
"data": "[\n{\n \"code\": \"AL\",\n\"sha\":      0.5,\n\"jef\":      0.5,\n\"fips\": 1,\n\"votes\": 58,\n\"abbreviation\": \"Ala.\",\n\"name\": \"Alabama\" \n},\n{\n \"code\": \"AZ\",\n\"sha\":  0.5,\n\"jef\":  0.5,\n\"fips\": 4,\n\"votes\": 78,\n\"abbreviation\": \"Ariz.\",\n\"name\": \"Arizona\" \n},\n{\n \"code\": \"CA\",\n\"sha\":      0.5,\n\"jef\":      0.5,\n\"fips\": 6,\n\"votes\": 339,\n\"abbreviation\": \"Calif.\",\n\"name\": \"California\" \n},\n{\n \"code\": \"FL\",\n\"sha\":  1,\n\"jef\":  0,\n\"fips\": 12,\n\"votes\": 216,\n\"abbreviation\": \"Fla.\",\n\"name\": \"Florida\" \n},\n{\n \"code\": \"IL\",\n\"sha\":      0.5,\n\"jef\":      0.5,\n\"fips\": 17,\n\"votes\": 74,\n\"abbreviation\": \"Ill.\",\n\"name\": \"Illinois\" \n},\n{\n \"code\": \"IN\",\n\"sha\":  0.5,\n\"jef\":  0.5,\n\"fips\": 18,\n\"votes\": 44,\n\"abbreviation\": \"Ind.\",\n\"name\": \"Indiana\" \n},\n{\n \"code\": \"KY\",\n\"sha\":      0.5,\n\"jef\":      0.5,\n\"fips\": 21,\n\"votes\": 94,\n\"abbreviation\": \"Ky.\",\n\"name\": \"Kentucky\" \n},\n{\n \"code\": \"LA\",\n\"sha\":      0.5,\n\"jef\":      0.5,\n\"fips\": 22,\n\"votes\": 39,\n\"abbreviation\": \"La.\",\n\"name\": \"Louisiana\" \n},\n{\n \"code\": \"MD\",\n\"sha\":      0.5,\n\"jef\":      0.5,\n\"fips\": 24,\n\"votes\": 57,\n\"abbreviation\": \"Md.\",\n\"name\": \"Maryland\" \n},\n{\n \"code\": \"MI\",\n\"sha\":  0.5,\n\"jef\":  0.5,\n\"fips\": 26,\n\"votes\": 86,\n\"abbreviation\": \"Mich.\",\n\"name\": \"Michigan\" \n},\n{\n \"code\": \"MN\",\n\"sha\":  0.5,\n\"jef\":  0.5,\n\"fips\": 27,\n\"votes\": 64,\n\"abbreviation\": \"Minn.\",\n\"name\": \"Minnesota\" \n},\n{\n \"code\": \"NC\",\n\"sha\":  0,\n\"jef\":  1,\n\"fips\": 37,\n\"votes\": 105,\n\"abbreviation\": \"N.C.\",\n\"name\": \"North Carolina\" \n},\n{\n \"code\": \"OH\",\n\"sha\":  0.5,\n\"jef\":  0.5,\n\"fips\": 39,\n\"votes\": 87,\n\"abbreviation\": \"Ohio\",\n\"name\": \"Ohio\" \n},\n{\n \"code\": \"OR\",\n\"sha\":  0.5,\n\"jef\":  0.5,\n\"fips\": 41,\n\"votes\": 41,\n\"abbreviation\": \"Ore.\",\n\"name\": \"Oregon\" \n},\n{\n \"code\": \"PA\",\n\"sha\":  0.5,\n\"jef\":  0.5,\n\"fips\": 42,\n\"votes\": 38,\n\"abbreviation\": \"Pa.\",\n\"name\": \"Pennsylvania\" \n},\n{\n \"code\": \"TX\",\n\"sha\":      0.5,\n\"jef\":      0.5,\n\"fips\": 48,\n\"votes\": 198,\n\"abbreviation\": \"Tex.\",\n\"name\": \"Texas\" \n},\n{\n \"code\": \"VA\",\n\"sha\":  0.5,\n\"jef\":  0.5,\n\"fips\": 51,\n\"votes\": 43,\n\"abbreviation\": \"Va.\",\n\"name\": \"Virginia\" \n},\n{\n \"code\": \"WA\",\n\"sha\":  0.5,\n\"jef\":  0.5,\n\"fips\": 53,\n\"votes\": 86,\n\"abbreviation\": \"Wash.\",\n\"name\": \"Washington\" \n},\n{\n \"code\": \"WV\",\n\"sha\":  1,\n\"jef\":  0,\n\"fips\": 54,\n\"votes\": 230,\n\"abbreviation\": \"W.Va.\",\n\"name\": \"West Virginia\" \n},\n{\n \"code\": \"WY\",\n\"sha\":      0,\n\"jef\":      1,\n\"fips\": 56,\n\"votes\": 229,\n\"abbreviation\": \"Wyo.\",\n\"name\": \"Wyoming\" \n} \n]",
"id": "g-chart"
}

var margin = {top: 85, right: 40, bottom: 40, left: 40},
    width = 1300 - margin.left - margin.right,
    height = 700 - margin.top - margin.bottom;

var numbers = ["no", "one", "two", "three", "four", "five", "six", "seven", "eight", "nine"],
    formatCandidate = {sha: "Sharief", jef: "Jeffers"},
    formatNumber = function(d) { return numbers[d] || d; },
    formatPercent = d3.format(".2p");

var y = d3.scale.pow()
    .exponent(2 / 3)
    .domain([0, 9])
    .rangeRound([0, height]);

var w = d3.scale.linear()
    .domain([0, 1])
    .range([1, 32]);

var svg = d3.select(".g-chart").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

// Per-type markers, as they don't inherit styles.
svg.append("defs").selectAll("marker")
    .data(["sha", "jef", "sha-active", "jef-active"])
  .enter().append("marker")
    .attr("id", function(d) { return "g-arrowhead-" + d; })
    .attr("viewBox", "-.1 -5 10 10")
    .attr("orient", "auto")
  .append("path")
    .attr("d", "M-.1,-4L3.9,0L-.1,4")
    .attr("class", function(d) { return "g-marker g-" + d; });

//change here to allow R to pass in data rather than the original
//d3.tsv("states.tsv", function(error, states) {
states = JSON.parse( params.data );

  var category = d3.scale.threshold()
      .domain([.6, .75, .92]) // .9
      .range(["tossup", "lean", "likely", "safe"]);

  var root = {
    shavotes: 0,
    jefvotes: 0,
    probability: 1,
    party: null,
    state: {}
  };

  states.forEach(function(d) {
    d.sha = +d.sha;
    d.jef = +d.jef;
    d.votes = +d.votes;
    d.category = category(Math.max(d.sha, d.jef));
    if (d.category === "safe") {
      if (d.sha > d.jef) root.shavotes += d.votes;
      else root.jefvotes += d.votes;
    }
  });

  states = states
      .filter(function(d) { return d.category !== "safe"; })
      .sort(function(a, b) { return b.votes - a.votes || a.name.localeCompare(b.name); })
      .map(function(d, i) { d.index = i; return d; });

  var tree = d3.layout.tree()
      .size([width, states.length])
      .separation(function(a, b) { return (a.probability + b.probability + .1) * (states.length - a.depth + 1); })
      .children(function(d, i) {
        if (i < states.length) {
          var s = states[i];
          return Math.max(d.shavotes, d.jefvotes) < 1103 && [
            {party: "sha", state: s, probability: d.probability / 2, shavotes: d.shavotes + s.votes, jefvotes: d.jefvotes},
            {party: "jef", state: s, probability: d.probability / 2, shavotes: d.shavotes, jefvotes: d.jefvotes + s.votes}
          ];
        }
      });

  var nodesByKey,
      oldNodesByKey,
      oldStates = states.slice(),
      bisect = d3.bisector(function(d) { return d.index; }).left,
      nodes = [],
      links = [],
      node = svg.selectAll(".g-node"),
      link = svg.selectAll(".g-link"),
      state = svg.selectAll(".g-state");

  var resetButton = d3.select(".g-controls").append("a")
      .attr("class", "g-reset")
      .text("Reset")
      .on("click", function() { reset(); transition(); });

  var control = d3.select(".g-controls").selectAll(".g-control")
      .data(states)
    .enter().append("div")
      .attr("class", "g-control");

  var controlButton = control.selectAll("button")
      .data(function(d) {
        return ["sha", "jef"].map(function(o) {
          return {state: d, outcome: o};
        });
      })
    .enter().append("button")
      .attr("class", function(d) { return "g-button g-" + d.outcome; })
      .text(function(d) { return d.outcome; })
      .on("click", function(view) { change(view); transition(); });

  control.append("span")
      .text(function(d) { return d.abbreviation; });

  var scoreboard = svg.append("g")
      .attr("class", "g-scoreboard")
      .attr("transform", "translate(" + ((width + margin.left + margin.right) / 2 - margin.left) + ",0)");

  var kicker = scoreboard.append("text")
      .attr("class", "g-kicker")
      .attr("y", -52);

  scoreboard.append("rect")
      .attr("x", -280)
      .attr("y", -80)
      .attr("width", 280 * 2)
      .attr("height", 80)

  scoreboard.append("path")
      .attr("d", "M-280,0H-20l20,20L20,0H280");

  var candidateScores = [
    {party: "sha", position: -280, align: "start"},
    {party: "jef", position: 280, align: "end"},
    {party: "tie", position: null, align: "middle"}
  ];

  scoreboard.selectAll(".g-prefix")
      .data(candidateScores)
    .enter().append("text")
      .attr("class", function(d) { return "g-" + d.party + " g-prefix"; })
      .attr("x", function(d) { return d.position; })
      .attr("y", "-1.2em")
      .style("text-anchor", function(d) { return d.align; })
      .text(function(d) { return d.party === "tie" ? "" : formatCandidate[d.party] + " has "; });

  scoreboard.selectAll(".g-prefix").append("tspan")
      .attr("class", "g-score");

  scoreboard.selectAll(".g-prefix").append("tspan")
      .attr("class", "g-suffix");

  scoreboard.append("text")
      .attr("class", "g-ratio g-sha")
      .attr("y", "-0.8em")
      .attr("x", -168);

  scoreboard.append("text")
      .attr("class", "g-ratio g-jef")
      .attr("y", "-0.8em")
      .attr("x", 170);

  scoreboard.append("text")
      .attr("class", "g-ratio g-tie")
      .attr("y", "-0.8em");

  var endAlert = svg.append("text")
      .attr("class", "g-alert")
      .attr("transform", "translate(" + ((width + margin.left + margin.right) / 2 - margin.left) + ",35)");

  endAlert.append("tspan")
      .attr("x", 0)
      .text("With these selections,");

  endAlert.append("tspan")
      .attr("class", "g-output")
      .attr("x", 0)
      .attr("y", "1.5em")
      .attr("class", "g-output");

  var scenarioButton = d3.selectAll(".g-scenario .g-button")
      .on("click", function() {
        var outcome = {};
        this.getAttribute("data-view").split("&").forEach(function(view) { outcome[view.substring(0, 2)] = view.substring(3); });
        controlButton.filter(function(d) {
          return d.state.enabledParty != outcome[d.state.code]
              && (!outcome[d.state.code] && d.state.enabledParty
                ? d.outcome === d.state.enabledParty
                : d.outcome === outcome[d.state.code]);
        }).each(change);
        transition();
      });

  update();

  function update() {
    root.children = null;
    nodes = tree.size([width, 1]).nodes(root);
    links = tree.links(nodes).reverse();
    root.x = (width + margin.right - margin.left) / 2;

    //
    nodesByKey = {};
    nodes.forEach(function(d) { nodesByKey[d.key = key(d)] = d; });

    updateStates();
    updateNodes();
    updateLinks();
    updateVoronoi();
    updateScoreboard();
  }

  function updateStates() {
    state = state.data(states, function(d) { return d.code; });

    d3.transition(state.exit())
        .style("fill-opacity", 1e-6)
        .attr("transform", function(d) { return "translate(" + (-margin.left + 10) + "," + y(bisect(states, d.index)) + ")"; })
        .remove();

    var stateEnter = state.enter().insert("g", ".g-scoreboard,.g-node,.g-link")
        .style("fill-opacity", 1e-6)
        .attr("class", "g-state")
        .attr("transform", function(d) { return "translate(" + (-margin.left + 10) + "," + y(bisect(oldStates, d.index)) + ")"; });

    d3.transition(state)
        .style("fill-opacity", 1)
        .attr("transform", function(d, i) { return "translate(" + (-margin.left + 10) + "," + y(i + 1) + ")"; });

    stateEnter.append("line")
        .attr("x2", width + margin.left - 10);

    stateEnter.append("rect")
        .attr("y", -16)
        .attr("width", 12)
        .attr("height", 12);

    stateEnter.selectAll("text")
        .data(["sha", "jef"])
      .enter().append("text")
        .attr("class", function(d) { return "g-" + d; })
        .attr("y", -6)
        .attr("x", 6)
        .style("text-anchor", "middle")
        .text(function(d) { return d.substring(0, 1).toUpperCase(); });

    stateEnter.append("text")
        .attr("x", 16)
        .attr("y", -6)
        .text(function(d) { return d.name; });
  }

  function updateLinks() {
    link = link.data(links, function(d) { return d.target.key; });

    var linkEnter = link.enter().insert("path", ".g-node")
        .attr("d", function(d) { var p = findOldParent(d.target); return diagonal({source: p, target: p}); })
        .attr("class", function(d) { return "g-link g-" + d.target.party; })
        .attr("marker-end", function(d) { return "url(#g-arrowhead-" + d.target.party + ")"; });

    d3.transition(link.exit())
        .attr("d", function(d) { var p = findParent(d.target); return diagonal({source: p, target: p}); })
        .remove();

    d3.selectAll(".g-link")
        .sort(ascendingDepth);

    d3.transition(link)
        .attr("d", diagonal)
        .style("stroke-width", function(d) { return w(d.target.probability) + "px"; });
  }

  function updateNodes() {
    node = node.data(nodes.slice(1), function(d) { return d.key; })
        .each(function(d) { d.update = true; });

    var nodeExit = d3.transition(node.exit())
        .attr("class", function(d) { return "g-node g-" + d.party; })
        .attr("transform", function(d) { var p = findParent(d); return "translate(" + p.x + "," + y(p.depth) + ")"; })
        .remove();

    var nodeEnter = node.enter().insert("g", ".g-scoreboard")
        .attr("class", function(d) { return "g-node g-" + d.party; })
        .attr("transform", function(d) { var p = findOldParent(d); return "translate(" + p.x + "," + y(p.depth) + ")"; });

    d3.transition(node)
        .attr("class", function(d) { return "g-node g-" + d.party + (d.depth === 1 ? " g-first" : ""); })
        .attr("transform", function(d) { return "translate(" + d.x + "," + y(d.depth) + ")"; });

    updateLabels(nodeEnter, nodeExit);
    updateLeaves(nodeEnter, nodeExit);
  }

  function updateLabels(nodeEnter, nodeExit) {
    var textEnter = nodeEnter.append("text").classed("g-label", true).attr("y", -6);
    textEnter.append("tspan").attr("class", "g-label-line1");
    textEnter.append("tspan").attr("class", "g-label-line2").attr("x", 0).attr("dy", ".71em");

    node.select(".g-label-line1")
        .attr("y", function(d) { return d.children ? null : -radius(d.depth) - 3; })
        .text(function(d) {
          var firstOfParty = true, p = d.parent;

          while (p && p.parent && firstOfParty) {
            if (p.party === d.party) firstOfParty = false;
            p = p.parent;
          }

          return firstOfParty ? "If " + formatCandidate[d.party] + " wins " + d.state.name + "\u2026"
              : d.children ? " " + d.state.abbreviation + ","
              : " and " + d.state.abbreviation + ",";
        });

    node.select(".g-label-line2")
        .attr("y", function(d) { return radius(d.depth) + 3; })
        .text(function(d) {
          return d.children ? null : (d.shavotes === d.jefvotes ? " the candidates tie." : formatCandidate[d.party] + " wins.");
        });
  }

  function updateLeaves(nodeEnter, nodeExit) {
    var leaf = node.selectAll(".g-leaf")
        .data(function(d) { return d.children ? [] : [d]; });

    var leafEnter = leaf.enter().insert("g", "text")
        .attr("class", function(d) { return "g-leaf" + (d.shavotes === d.jefvotes ? " g-tie" : ""); })
        .attr("transform", "scale(0)");

    leafEnter.append("circle")
        .attr("r", 50);

    leafEnter.append("path")
        .attr("class", "g-check")
        .attr("transform", "translate(-8,16)")
        .attr("d", "M-20,-20L0,0L38,-38");

    d3.transition(leaf.exit())
        .attr("transform", "scale(0)")
        .remove();

    nodeExit.select(".g-leaf")
        .attr("transform", "scale(0)");

    d3.transition(leaf)
        .attr("transform", function(d) { return "scale(" + radius(d.depth) + ")scale(.02)"; });
  }

  function updateVoronoi() {
    svg.select(".g-voronoi").remove();

    svg.append("g")
        .attr("class", "g-voronoi")
        .call(voronoi, nodes);
  }

  function updateScoreboard() {
    var shaPaths = 0,
        jefPaths = 0,
        tiePaths = 0;

    nodes.forEach(function(d) {
      if (!d.children) {
        var n = Math.pow(2, states.length - d.depth);
        if (d.shavotes > d.jefvotes) shaPaths += n;
        else if (d.jefvotes > d.shavotes) jefPaths += n;
        else tiePaths += n;
      }
    });

    //
    kicker.text("With " + formatNumber(states.length) + " state" + (states.length > 1 ? "s" : "") + " undecided:");
    scoreboard.select(".g-prefix.g-sha .g-score").text(shaPaths);
    scoreboard.select(".g-prefix.g-sha .g-suffix").text(" way" + ((shaPaths === 1) ? "" : "s") + " to win");
    scoreboard.select(".g-prefix.g-jef .g-score").text(jefPaths);
    scoreboard.select(".g-prefix.g-jef .g-suffix").text(" way" + ((jefPaths === 1) ? "" : "s") + " to win");
    scoreboard.select(".g-prefix.g-tie .g-score").text(tiePaths);
    scoreboard.select(".g-prefix.g-tie .g-suffix").text(" tie" + ((tiePaths === 1) ? "" : "s"));

    //
    var totalPaths = 1 << states.length;
    scoreboard.select(".g-sha.g-ratio").text(formatPercent(shaPaths / totalPaths) + " of paths");
    scoreboard.select(".g-jef.g-ratio").text(formatPercent(jefPaths / totalPaths) + " of paths");
    scoreboard.select(".g-tie.g-ratio").text(formatPercent(tiePaths / totalPaths) + " of paths");

    if (nodes.length === 1) {
      endAlert.select(".g-output").text((root.shavotes > root.jefvotes ? "Sharief wins" : root.shavotes < root.jefvotes ? "Jeffers wins" : "the candidates tie") + " in all scenarios.");
      endAlert.transition().style("opacity", 1);
      if (root.shavotes > root.jefvotes) {
        d3.select(".g-heads .g-sha").style("opacity", 1).style("left", "-100px");
        d3.select(".g-heads .g-jef").style("opacity", 0).style("left", "-100px");
      } else if (root.shavotes < root.jefvotes) {
        d3.select(".g-heads .g-jef").style("opacity", 1).style("left", "-100px");
        d3.select(".g-heads .g-sha").style("opacity", 0).style("left", "-100px");
      } else {
        d3.select(".g-heads .g-sha").style("opacity", 1).style("left", "-220px");
        d3.select(".g-heads .g-jef").style("opacity", 1).style("left", "20px");
      }
    } else {
      endAlert.transition().style("opacity", 0);
      d3.select(".g-heads .g-sha").style("opacity", 0);
      d3.select(".g-heads .g-jef").style("opacity", 0);
    }
  }

  function reset() {
    controlButton.filter(function(d) { return d.outcome === d.state.enabledParty; }).each(change);
  }

  function change(view) {
    var key = view.state.code + "=" + view.outcome;

    if (view.state.enabledParty) {
      root[view.state.enabledParty + "votes"] -= view.state.votes;
      states.splice(bisect(states, view.state.index), 0, view.state);
    }

    var i = bisect(oldStates, view.state.index) + 1;

    if (view.outcome === view.state.enabledParty) {
      view.state.enabledParty = null;

      // Add the exiting state to nodes below.
      nodes.forEach(function(d) {
        if (d.depth >= i) d.key = d.key.split("&").concat(key).sort().join("&");
      });
    } else {
      if ((root[view.outcome + "votes"] += view.state.votes) >= 1103) root.party = view.outcome;
      view.state.enabledParty = view.outcome;
      states.splice(states.indexOf(view.state), 1);

      // Remove the entering state from nodes below.
      var k = new RegExp("&" + key + "|" + key + "&");
      nodes.forEach(function(d) {
        if (d.depth > i) d.key = d.key.replace(k, "");
      });
    }
  }

  function transition() {
    controlButton.classed("g-active", function(d) { return d.state.enabledParty === d.outcome; });
    resetButton.style("display", states.length < y.domain()[1] ? "block" : "none");

    // Old node positions indexed by new key are needed for enter transitions.
    oldNodesByKey = {};
    nodes.forEach(function(d) { oldNodesByKey[d.key] = d; });

    d3.transition().duration(d3.event.altKey ? 7500 : 750).each(update);

    // The previous states are needed when multiple changes are made pre-transition.
    oldStates = states.slice();
  }

  function click(d) {
    mouseout(d);
    var p = d.parent;
    while (p) {
      if (p.parent === root) { d = p; break; }
      p = p.parent;
    }
    if (d !== root) {
      change({state: d.state, outcome: d.party});
      transition();
    }
  }

  function mouseover(d) {
    activate(d, true);
    svg.attr("class", "g-" + d.party);
    node.filter(function(d) { return d.active; }).classed("g-active", true);
    link.filter(function(d) { return d.target.active; }).classed("g-active", true).attr("marker-end",

function(d) { return "url(#g-arrowhead-" + d.target.party + "-active)"; });
    state.attr("class", function(d) { return "g-state" + (d.activeParty ? " g-" + d.activeParty : ""); });
  }

  function mouseout(d) {
    node.filter(function(d) { return d.active; }).classed("g-active", false);
    link.filter(function(d) { return d.target.active; }).classed("g-active", false).attr("marker-end", function(d) { return "url(#g-arrowhead-" + d.target.party + ")"; });
    state.attr("class", "g-state");
    activate(d, false);
  }

  function activate(d, active) {
    d.active = active;
    d.state.activeParty = active ? d.party : null;
    d.parent && activate(d.parent, active);
  }

  function voronoi(g, nodes) {
    nodes = nodes.filter(function(d) { return !d.children; });

    var x0 = -margin.left, y0 = 0,
        x1 = width + margin.right, y1 = height + margin.left,
        xy = d3.geom.polygon([[x0, y0], [x0, y1], [x1, y1], [x1, y0]]);

    var path = g.selectAll("path")
        .data(d3.geom.voronoi(nodes.map(function(d) { return [d.x, y(d.depth)]; })));

    path.enter().append("path")
        .on("mouseover", mouseover)
        .on("mouseout", mouseout)
        .on("mousedown", function() { d3.event.preventDefault(); })
        .on("dblclick", click);

    path.attr("d", function(d) { return "M" + xy.clip(d).join("L") + "Z"; })
        .datum(function(d, i) { return nodes[i]; });

    path.exit().remove();
  }

  function key(d) {
    if (!d.parent) return "_root";
    var k = [], p = d;
    while (p && p.party) k.push(p.state.code + "=" + p.party), p = p.parent;
    return k.sort().join("&");
  }

  function findParent(d) {
    var p = d.parent;
    while (p) {
      if ((d = nodesByKey[p.key]) && d.update) return d;
      p = p.parent;
    }
    return root;
  }

  function findOldParent(d) {
    var p = findParent(d);
    return oldNodesByKey ? oldNodesByKey[p.key] : p;
  }
//comment this out from d3.tsv above since data provided by R
//});

function ascendingDepth(b, a) {
  return a.target.depth - b.target.depth;
}

function radius(depth) {
  return Math.pow(2, 5.8 - depth / 2);
}

function diagonal(d) {
  var x0 = d.source.x, y0 = y(d.source.depth),
      x1 = d.target.x, y1 = y(d.target.depth);
  if (x0 < x1) x0 += w(d.target.probability) / 2;
  else if (x0 > x1) x0 -= w(d.target.probability) / 2;
  return "M" + x0 + "," + y0
      + "C" + x0 + "," + (y0 + y1) / 2
      + "," + x1 + "," + (y0 + y1) / 2
      + "," + x1 + "," + y1;
}

})();

</script>

<script></script>

    </div>

</body>
  <script src="libraries/frameworks/bootstrap/js/vendor/bootstrap.min.js"></script>
  <script src="libraries/frameworks/bootstrap/js/plugins.js"></script>
  <script src="libraries/frameworks/bootstrap/js/main.js"></script>
  <!-- Load Javascripts for Widgets -->

  <!-- Google Prettify -->
  <script src="http://cdnjs.cloudflare.com/ajax/libs/prettify/188.0.0/prettify.js"></script>
  <script src='libraries/highlighters/prettify/js/lang-r.js'></script>
  <script>
    var pres = document.getElementsByTagName("pre");
    for (var i=0; i < pres.length; ++i) {
      pres[i].className = "prettyprint linenums";
    }
    prettyPrint();
  </script>
  <!-- End Google Prettify -->
  </html>
